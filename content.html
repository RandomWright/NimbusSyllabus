<!DOCTYPE html>
<html>
	<head>
		<title>Nimbus Syllabus</title>
		<link rel="stylesheet" type="text/css" href="http://nimsyllabus.com/style.css">
		<link rel="shortcut icon" type="image/png" href="http://nimsyllabus.com/favicon.png">
		<link rel="icon" type="image/png" href="http://nimsyllabus.com/favicon.png">

		<script src="http://nimsyllabus.com/jquery-3.1.1.min.js"></script>
		<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
		        
		<script>
		var groupButtonsString = '<div class="group_buttons"><button class="group_hide">hide</button><button class="group_edit">edit</button><button class="group_delete">x</button></div><div class="group_content"><div class="group_upload_file">Add Coursework<input id="fileupload" type="file" name="files[]" data-url="server/php/"></div>';

		$(document).ready(function(){
			$('.group_form').bind('submit', function(e) {
				$('.message').remove();

		        e.preventDefault();
				var data = $(this).serialize();
				data += "&submit=%2B%20New%20Group";

		        $.ajax({
		        	url: "http://nimsyllabus.com/cgi-bin/nimbus-accounts.py", 
		        	type: "GET",
		        	data: data,
		        	success: function(data, textStatus, jqXHR){
		        		/*$('html').html(result);*/

						/*var groupHeader = $('.group_header');
						groupHeader.animate({height: 0, "margin" : 0}, function() {
							groupHeader.remove();
						});*/


						var groupEndDivIndex = data.length - 7;
						var splicedData = data.substr(0, groupEndDivIndex) + groupButtonsString;

		        		var resultDiv = $('.group_container').prepend(splicedData);
		       		}
		        });
		    });

		    $('.group').each(function(i, obj) {
		    	$(obj).append(groupButtonsString);
			});
			
			$('body').on('click', '.group_delete', function(){
				/*var buttonClass = $(this).attr('class');
				if(buttonClass == 'group_delete'){
		        	var groupHeader = $('.group_header');
		        	groupHeader.append('equal');
				}*/

			    var groupDiv = $(this).parent().parent(); /* first parent is button tray (group_buttons) */
			    var groupId = groupDiv.attr("id"); /*$(this).attr("id");*/
			    var groupData = {"submit" : "Delete",
			    				 "id" : groupId};

				$.ajax({
		        	url: "http://nimsyllabus.com/cgi-bin/nimbus-accounts.py",
		        	type: "GET",
		        	data: groupData,
		        }).always(function(data, textStatus, jqXHR){
		        	var trimmedResultString = $.trim(data);
		        	if(trimmedResultString == 'Success'){
		        		/*var groupHeader = $('.group_header');
		        		groupHeader.animate({height: 0, "margin" : 0}, function() {
				        	groupHeader.remove();
			        	});*/

		        		groupDiv.animate({height: 0, "padding-top" : 0, "padding-bottom" : 0}, function() {
				        	groupDiv.remove();
		        		});
		        	}
		        	else{
				    	groupDiv.append('Failed to delete: "' + trimmedResultString + '" inside of ' + groupDiv);
		        	}
	       		});			
			});

			$('body').on('click', '.group_hide', function(){
				var groupHideButton = $(this);
			    var groupDiv = groupHideButton.parent().parent(); /* first parent is button tray (group_buttons) */
			    var groupContentDiv = groupDiv.find('.group_content');

  				groupContentDiv.slideUp("slow", function() {
    				groupHideButton.replaceWith('<button class="group_show" style="margin-right: 10px;">show</button>');
		        });
			});

			$('body').on('click', '.group_show', function(){
				var groupShowButton = $(this);
			    var groupDiv = groupShowButton.parent().parent();
			    var groupContentDiv = groupDiv.find('.group_content');

  				groupContentDiv.slideDown("slow", function() {
    				groupShowButton.replaceWith('<button class="group_hide">hide</button>');
		        });
			});
		});
		</script>
        
        
        <script>
         $(function () {
            var dialog = $("#dialog").dialog({
                    modal: true,
                    autoOpen: false,
                    title: "",
                    width: 300,
                    height: 100,
    		});
 
			$('body').on('click', '.group_edit', function(){
				var groupDiv = $(this).parent().parent();
				dialog.dialog({title: groupDiv.attr("id")});
                $('#dialog').dialog('open');
            });


			$('body').on('click', '.editor', function(event) {
      			event.preventDefault();
        		
        		var editNameFieldVal = encodeURIComponent($(".edit_name_field").val());
        		var editColorVal = encodeURIComponent($(".edit_name_color").val());
        		var groupId = dialog.dialog("option", "title");

				var data = "submit=EditGroup&edit_group_name=" + editNameFieldVal + "&group_id=" + groupId + "&edit_group_color=" + editColorVal;
				console.log(data);

		        $.ajax({
		        	url: "http://nimsyllabus.com/cgi-bin/nimbus-accounts.py", 
		        	type: "GET",
		        	data: data,
		        	success: function(data, textStatus, jqXHR){
		        		/*$('html').html(result);*/
		        		console.log("succeed");
		                $('#dialog').dialog('close');

		                $(".group_container").replaceWith(data);

		                $('.group').each(function(i, obj) {
		    				$(obj).append(groupButtonsString);
						});

		        		$(".edit_name_field").val("");
		        		$(".edit_name_color").val("#000000");
		       		},
		       		error: function(result){
		        		console.log("fail");

		        		$(".edit_name_field").val("");
		        		$(".edit_name_color").val("");

		                $('#dialog').dialog('close');
		       		}
		        });
			});


		});
        </script>
        
        <div id="dialog">
            <form id="edit" action="">
				<input class="edit_name_field" type="name" placeholder="edit group name" name="group_name_e"/>
				<input class="edit_name_color" type="not-fancy-color" placeholder="color" name="group_color_e"/><br/>
			</form>
            <button class="editor" form="edit"/>Edit</button><br/>
        </div>
	</head>

	<body>
		
		<div class="header">
			<a href="http://nimsyllabus.com"><img src="http://nimsyllabus.com/favicon.png" />
			<h1>Nimbus Syllabus</h1></a>			
		</div>

		<div class="footer">
			<div class="logout"><a style="color: #57a4ed;" href="http://nimsyllabus.com/cgi-bin/nimbus-accounts.py?submit=Logout">Log out</a></div>
			
			<form class="group_form" action="">
				<input type="name" placeholder="new group name" name="group_name"/>
				<input type="color" placeholder="color" name="group_color"/><br/>
				<input type="submit" name="submit" value="+ New Group"/><br/>
			</form>
		</div>				
		
		<script language="javascript">
			(function() {
				loginIfPossible();

	            function lookCookie(name){
	                var cookiepart = name + "=";
	         	    var ca = document.cookie.split(';');
	        	    for (var i = 0; i < ca.length; i++) {
	                	var c = ca[i];
						while (c.charAt(0) == ' ') {
	                   		c = c.substring(1);
	                	}
	                	
	                	if (c.indexOf(cookiepart) == 0) {
	                		//if the cookie is found return cookie
	                    	return c.substring(cookiepart.length, c.length);
	                	}
	                	
	                	return "";
	                }
				}

				function loginIfPossible() {
		           	var username = lookCookie('account_cookie');

		            if (!username || username.length == 0) {
		                document.location.href = 'http://nimsyllabus.com/index.html';
		            }

		            else {
		            	var lazy_load_url = 'http://nimsyllabus.com/cgi-bin/nimbus-accounts.py?submit=Cookie+Login&username=' + username;

		            	if (document.location.href != lazy_load_url) {
			                document.location.href = 'http://nimsyllabus.com/cgi-bin/nimbus-accounts.py?submit=Cookie+Login&username=' + username;
		            	}

		            	else {
		            		var logoutDiv = document.getElementsByClassName('logout');
							logoutDiv[0].innerHTML = '<div class="username">' + username + "</div>" + logoutDiv[0].innerHTML;
		            	}
		            }
				}
           	})();
        </script>
	</body>
</html>